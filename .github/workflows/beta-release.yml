name: Beta Release

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch/tag/SHA) to build"
        required: false
        default: "main"
      tag:
        description: "Release tag override (optional)"
        required: false
      release_name:
        description: "Release name override (optional)"
        required: false
      notes:
        description: "Optional beta notes"
        required: false

permissions:
  contents: write

jobs:
  build-desktop:
    name: Build Desktop (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux
            os: ubuntu-22.04
            artifact_label: linux
          - name: macOS
            os: macos-latest
            artifact_label: macos
          - name: Windows
            os: windows-latest
            artifact_label: windows

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          if ! sudo apt-get install -y libwebkit2gtk-4.1-dev; then
            sudo apt-get install -y libwebkit2gtk-4.0-dev
          fi
          sudo apt-get install -y \
            libgtk-3-dev \
            libxdo-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install desktop dependencies
        working-directory: desktop
        run: bun install --frozen-lockfile

      - name: Build desktop app
        working-directory: desktop
        run: bun run build

      - name: Package desktop bundle
        id: package
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-artifacts
          archive="steam-spotify-${{ matrix.platform.artifact_label }}-${GITHUB_RUN_NUMBER}.tar.gz"
          tar -czf "release-artifacts/${archive}" -C desktop/src-tauri/target/release/bundle .
          echo "archive=${archive}" >> "$GITHUB_OUTPUT"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.platform.artifact_label }}
          path: release-artifacts/${{ steps.package.outputs.archive }}
          if-no-files-found: error

  create-beta-release:
    name: Create Beta Release
    runs-on: ubuntu-latest
    needs: build-desktop

    steps:
      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.event.inputs.tag }}"
          if [ -z "${tag}" ]; then
            tag="beta-$(date -u +%Y%m%d)-${GITHUB_RUN_NUMBER}"
          fi

          release_name="${{ github.event.inputs.release_name }}"
          if [ -z "${release_name}" ]; then
            release_name="Steam Spotify Beta ${tag}"
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "release_name=${release_name}" >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: desktop-*
          merge-multiple: true

      - name: Publish prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.event.inputs.ref || github.sha }}
          name: ${{ steps.meta.outputs.release_name }}
          prerelease: true
          generate_release_notes: true
          body: ${{ github.event.inputs.notes }}
          files: release-artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
